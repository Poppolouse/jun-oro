using System;
using System.IO;
using LibGit2Sharp;

namespace NotionCodeAutomator
{
    public class GitManager
    {
        private string _repoPath;
        public event Action<string, bool> OnLog; // message, isError

        public GitManager(string repoPath)
        {
            _repoPath = repoPath;
        }

        // Git repository var mÄ± kontrol et
        public bool IsGitRepository()
        {
            try
            {
                string gitPath = Path.Combine(_repoPath, ".git");
                return Directory.Exists(gitPath);
            }
            catch
            {
                return false;
            }
        }

        // DeÄŸiÅŸiklikleri commit ve push yap
        public bool CommitAndPush(int operationCount)
        {
            try
            {
                if (!IsGitRepository())
                {
                    OnLog?.Invoke("âš ï¸ Git repository bulunamadÄ±. Ã–nce 'git init' yapÄ±n.", true);
                    return false;
                }

                using (var repo = new Repository(_repoPath))
                {
                    // DeÄŸiÅŸiklik var mÄ± kontrol et
                    var status = repo.RetrieveStatus();
                    if (!status.IsDirty)
                    {
                        OnLog?.Invoke("â„¹ï¸ Commit edilecek deÄŸiÅŸiklik yok.", false);
                        return true;
                    }

                    // Stage all changes
                    Commands.Stage(repo, "*");
                    OnLog?.Invoke("ğŸ”„ Dosyalar staged edildi.", false);

                    // Commit
                    string message = $"[NotionAutomator] {operationCount} iÅŸlem uygulandÄ± - {DateTime.Now:yyyy-MM-dd HH:mm}";
                    var signature = new Signature("NotionAutomator", "automator@notion.local", DateTimeOffset.Now);

                    try
                    {
                        repo.Commit(message, signature, signature);
                        OnLog?.Invoke($"ğŸ’¾ Commit: {message}", false);
                    }
                    catch (EmptyCommitException)
                    {
                        OnLog?.Invoke("â„¹ï¸ BoÅŸ commit, atlanÄ±yor.", false);
                        return true;
                    }

                    // Push
                    try
                    {
                        var remote = repo.Network.Remotes["origin"];
                        if (remote == null)
                        {
                            OnLog?.Invoke("âš ï¸ Remote 'origin' bulunamadÄ±. Ã–nce remote ekleyin.", true);
                            return false;
                        }

                        var currentBranch = repo.Head;

                        // Credential provider ile push
                        var pushOptions = new PushOptions
                        {
                            CredentialsProvider = (url, usernameFromUrl, types) =>
                            {
                                // Windows Credential Manager'dan otomatik okumayÄ± dene
                                return new DefaultCredentials();
                            }
                        };

                        try
                        {
                            repo.Network.Push(currentBranch, pushOptions);
                            OnLog?.Invoke($"ğŸš€ Push baÅŸarÄ±lÄ±! â†’ {currentBranch.FriendlyName}", false);
                            return true;
                        }
                        catch
                        {
                            // Fallback: KullanÄ±cÄ±dan token iste
                            OnLog?.Invoke("âš ï¸ Credential hatasÄ±. Manuel push gerekli:", true);
                            OnLog?.Invoke("Terminal'de ÅŸunu Ã§alÄ±ÅŸtÄ±r:", false);
                            OnLog?.Invoke($"cd \"{_repoPath}\"", false);
                            OnLog?.Invoke("git push", false);
                            return false;
                        }
                    }
                    catch (Exception pushEx)
                    {
                        OnLog?.Invoke($"âŒ Push hatasÄ±: {pushEx.Message}", true);
                        OnLog?.Invoke("ğŸ’¡ Ã‡Ã¶zÃ¼m: Terminal'den manuel push yap", false);
                        OnLog?.Invoke($"cd \"{_repoPath}\" && git push", false);
                        return false;
                    }
                }
            }
            catch (Exception ex)
            {
                OnLog?.Invoke($"âŒ Git hatasÄ±: {ex.Message}", true);
                return false;
            }
        }

        // Repository bilgilerini gÃ¶ster
        public string GetRepositoryInfo()
        {
            try
            {
                if (!IsGitRepository())
                    return "Git repository deÄŸil";

                using (var repo = new Repository(_repoPath))
                {
                    var branch = repo.Head.FriendlyName;
                    var remote = repo.Network.Remotes["origin"]?.Url ?? "Remote yok";
                    return $"Branch: {branch} | Remote: {remote}";
                }
            }
            catch (Exception ex)
            {
                return $"Hata: {ex.Message}";
            }
        }
    }
}
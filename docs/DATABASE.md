# Jun-Oro VeritabanÄ± DokÃ¼mantasyonu

## ðŸ“‹ Genel BakÄ±ÅŸ

Jun-Oro platformu, veritabanÄ± yÃ¶netimi iÃ§in **PostgreSQL** ve **Prisma ORM** kullanÄ±r. VeritabanÄ± ÅŸemasÄ±, oyun kÃ¼tÃ¼phanesi yÃ¶netimi, kullanÄ±cÄ± takibi ve oyun oturumlarÄ± gibi temel iÅŸlevleri destekleyecek ÅŸekilde tasarlanmÄ±ÅŸtÄ±r.

## ðŸ—„ï¸ VeritabanÄ± ÅžemasÄ±

### Temel Modeller

#### User Modeli

```sql
CREATE TABLE users (
  id              TEXT PRIMARY KEY,
  name            TEXT NOT NULL,
  email           TEXT UNIQUE,
  username        TEXT UNIQUE,
  password        TEXT,
  role            TEXT DEFAULT 'user',
  status          TEXT DEFAULT 'pending',
  profileImage    TEXT,
  profileImageKey TEXT,
  createdAt       TIMESTAMP DEFAULT NOW(),
  updatedAt       TIMESTAMP DEFAULT NOW(),
  lastActive      TIMESTAMP DEFAULT NOW()
);
```

**AÃ§Ä±klama:**

- `id`: CUID formatÄ±nda benzersiz kullanÄ±cÄ± kimliÄŸi
- `role`: 'user', 'admin', 'moderator' deÄŸerlerini alabilir
- `status`: 'pending', 'active', 'suspended' durumlarÄ±nÄ± takip eder
- `profileImageKey`: Cloudflare R2'deki dosya silmek iÃ§in kullanÄ±lÄ±r

#### Game Modeli

```sql
CREATE TABLE games (
  id               TEXT PRIMARY KEY,
  name             TEXT NOT NULL,
  cover            TEXT,
  coverKey         TEXT,
  firstReleaseDate TIMESTAMP,
  genres           JSONB,
  platforms        JSONB,
  summary          TEXT,
  rating           FLOAT,
  developer        TEXT,
  steamData        JSONB,
  igdbData         JSONB,
  hltbData         JSONB,
  metacriticData   JSONB,
  cachedAt         TIMESTAMP DEFAULT NOW(),
  lastAccessed     TIMESTAMP DEFAULT NOW(),
  accessCount      INTEGER DEFAULT 1
);
```

**AÃ§Ä±klama:**

- `id`: External API'lerden gelen oyun ID'si
- `JSONB` alanlarÄ±: Esnek veri depolama iÃ§in kullanÄ±lÄ±r
- `cachedAt`: Verinin ne zaman Ã¶nbelleÄŸe alÄ±ndÄ±ÄŸÄ±nÄ± takip eder
- `accessCount`: PopÃ¼ler oyunlarÄ± belirlemek iÃ§in kullanÄ±lÄ±r

#### LibraryEntry Modeli

```sql
CREATE TABLE library_entries (
  id         TEXT PRIMARY KEY,
  userId     TEXT NOT NULL,
  gameId     TEXT NOT NULL,
  category   TEXT DEFAULT 'wishlist',
  playtime   INTEGER DEFAULT 0,
  rating     FLOAT,
  notes      TEXT,
  lastPlayed TIMESTAMP,
  progress   INTEGER DEFAULT 0,
  priority   INTEGER DEFAULT 3,
  isPublic   BOOLEAN DEFAULT FALSE,
  tags       JSONB,
  addedAt    TIMESTAMP DEFAULT NOW(),
  updatedAt  TIMESTAMP DEFAULT NOW(),
  UNIQUE(userId, gameId)
);
```

**AÃ§Ä±klama:**

- `category`: 'wishlist', 'playing', 'completed', 'backlog' deÄŸerlerini alabilir
- `priority`: 1 (yÃ¼ksek) - 5 (dÃ¼ÅŸÃ¼k) Ã¶ncelik skalasÄ±
- `tags`: Etiketleme sistemi iÃ§in JSON formatÄ±nda veri

### Ä°liÅŸkisel Modeller

#### GameSession Modeli

```sql
CREATE TABLE game_sessions (
  id        TEXT PRIMARY KEY,
  userId    TEXT NOT NULL,
  gameId    TEXT NOT NULL,
  gameName  TEXT NOT NULL,
  startTime TIMESTAMP DEFAULT NOW(),
  endTime   TIMESTAMP,
  playtime  INTEGER DEFAULT 0,
  isActive  BOOLEAN DEFAULT TRUE,
  campaigns JSONB,
  platform  TEXT,
  status    TEXT
);
```

**AÃ§Ä±klama:**

- `isActive`: Aktif oturumlarÄ± takip etmek iÃ§in
- `campaigns`: Oyun iÃ§indeki kampanya/hikaye ilerlemesi
- `playtime`: Saniye cinsinden oyun sÃ¼resi

#### Campaign Modeli

```sql
CREATE TABLE campaigns (
  id               TEXT PRIMARY KEY,
  gameId           TEXT NOT NULL,
  name             TEXT NOT NULL,
  description      TEXT,
  averageDuration  TEXT,
  customProperties JSONB,
  parentId         TEXT,
  isAutoGenerated  BOOLEAN DEFAULT FALSE,
  isMainCampaign   BOOLEAN DEFAULT FALSE,
  difficulty       TEXT,
  features         JSONB,
  createdAt        TIMESTAMP DEFAULT NOW()
);
```

**AÃ§Ä±klama:**

- `parentId`: Alt kampanyalar iÃ§in hiyerarÅŸik yapÄ±
- `isMainCampaign`: Ana hikaye kampanyasÄ± belirlemek iÃ§in
- `difficulty': 'easy', 'normal', 'hard', 'nightmare' gibi zorluk seviyeleri

### Destek Modelleri

#### UserPreferences Modeli

```sql
CREATE TABLE user_preferences (
  id                    TEXT PRIMARY KEY,
  userId                TEXT UNIQUE NOT NULL,
  preferredPlatform     TEXT,
  preferredStatus       TEXT DEFAULT 'Oynamak Ä°stiyorum',
  includeDLCs           BOOLEAN DEFAULT FALSE,
  selectedDLCs          JSONB,
  selectedCampaigns     JSONB,
  preferredVersion      TEXT,
  gameSpecificPrefs     JSONB,
  autoLoadHLTB          BOOLEAN DEFAULT TRUE,
  autoLoadMetacritic    BOOLEAN DEFAULT TRUE,
  autoGenerateCampaigns BOOLEAN DEFAULT TRUE
);
```

#### UserStats Modeli

```sql
CREATE TABLE user_stats (
  id             TEXT PRIMARY KEY,
  userId         TEXT UNIQUE NOT NULL,
  totalPlayTime  INTEGER DEFAULT 0,
  totalSessions  INTEGER DEFAULT 0,
  gamesPlayed    INTEGER DEFAULT 0,
  gamesCompleted INTEGER DEFAULT 0,
  lastPlayedGame TEXT,
  lastPlayedAt   TIMESTAMP,
  weeklyStats    JSONB,
  monthlyStats   JSONB,
  achievements   JSONB
);
```

## ðŸ”— Tablo Ä°liÅŸkileri

### Ä°liÅŸki DiyagramÄ±

```
Users (1) â”€â”€â”€â”€â”€â”€â”€â”€ (N) LibraryEntries
  â”‚                        â”‚
  â”‚                        â”‚
  â”‚                        â””â”€â”€â”€ (1) Games
  â”‚
  â”œâ”€â”€ (1) â”€â”€â”€â”€ (N) GameSessions â”€â”€â”€â”€ (N) Games
  â”‚
  â”œâ”€â”€ (1) â”€â”€â”€â”€ (1) UserPreferences
  â”‚
  â”œâ”€â”€ (1) â”€â”€â”€â”€ (1) UserStats
  â”‚
  â”œâ”€â”€ (1) â”€â”€â”€â”€ (N) Notifications
  â”‚
  â””â”€â”€ (1) â”€â”€â”€â”€ (N) AdminAuditLogs

Games (1) â”€â”€â”€â”€â”€â”€â”€â”€ (N) Campaigns
  â”‚
  â””â”€â”€ (1) â”€â”€â”€â”€ (N) GameSessions
```

### Foreign Key Ä°liÅŸkileri

```sql
-- LibraryEntry -> User
ALTER TABLE library_entries
ADD CONSTRAINT fk_library_user
FOREIGN KEY (userId) REFERENCES users(id) ON DELETE CASCADE;

-- LibraryEntry -> Game
ALTER TABLE library_entries
ADD CONSTRAINT fk_library_game
FOREIGN KEY (gameId) REFERENCES games(id) ON DELETE CASCADE;

-- GameSession -> User
ALTER TABLE game_sessions
ADD CONSTRAINT fk_session_user
FOREIGN KEY (userId) REFERENCES users(id) ON DELETE CASCADE;

-- GameSession -> Game
ALTER TABLE game_sessions
ADD CONSTRAINT fk_session_game
FOREIGN KEY (gameId) REFERENCES games(id) ON DELETE CASCADE;

-- Campaign -> Game
ALTER TABLE campaigns
ADD CONSTRAINT fk_campaign_game
FOREIGN KEY (gameId) REFERENCES games(id) ON DELETE CASCADE;

-- Campaign -> Campaign (self-referencing)
ALTER TABLE campaigns
ADD CONSTRAINT fk_campaign_parent
FOREIGN KEY (parentId) REFERENCES campaigns(id);
```

## ðŸ“Š Veri Tipleri ve KÄ±sÄ±tlamalar

### Veri Tipleri

| Alan AdÄ±  | Veri Tipi | AÃ§Ä±klama                         | Ã–rnek                  |
| --------- | --------- | -------------------------------- | ---------------------- |
| id        | TEXT      | CUID formatÄ±nda benzersiz kimlik | `clx123abc456`         |
| name      | TEXT      | String veri                      | "The Witcher 3"        |
| rating    | FLOAT     | OndalÄ±klÄ± sayÄ±                   | 8.5                    |
| playtime  | INTEGER   | Tam sayÄ± (saniye)                | 3600                   |
| createdAt | TIMESTAMP | Zaman damgasÄ±                    | `2024-01-01 12:00:00`  |
| isActive  | BOOLEAN   | True/False                       | `true`                 |
| genres    | JSONB     | JSON veri                        | `["RPG", "Adventure"]` |

### KÄ±sÄ±tlamalar

#### Unique KÄ±sÄ±tlamalarÄ±

```sql
-- Her kullanÄ±cÄ±nÄ±n her oyun iÃ§in sadece bir kÃ¼tÃ¼phane giriÅŸi olabilir
UNIQUE(userId, gameId) ON library_entries

-- Email adresleri benzersiz olmalÄ±
UNIQUE(email) ON users

-- KullanÄ±cÄ± adlarÄ± benzersiz olmalÄ±
UNIQUE(username) ON users

-- Platform adlarÄ± benzersiz olmalÄ±
UNIQUE(name) ON platforms
```

#### Check KÄ±sÄ±tlamalarÄ±

```sql
-- Rating deÄŸerleri 0-10 arasÄ±nda olmalÄ±
CHECK (rating >= 0 AND rating <= 10) ON games

-- Progress deÄŸerleri 0-100 arasÄ±nda olmalÄ±
CHECK (progress >= 0 AND progress <= 100) ON library_entries

-- Priority deÄŸerleri 1-5 arasÄ±nda olmalÄ±
CHECK (priority >= 1 AND priority <= 5) ON library_entries

-- Playtime negatif olamaz
CHECK (playtime >= 0) ON game_sessions
```

## ðŸ”„ Migration SÃ¼reci

### Migration OluÅŸturma

```bash
# Yeni migration oluÅŸtur
npx prisma migrate dev --name add_new_feature

# Development ortamÄ±nda uygula
npx prisma migrate dev

# Production ortamÄ±na daÄŸÄ±t
npx prisma migrate deploy
```

### Migration Ã–rneÄŸi

```sql
-- Migration: 20240101000000_add_game_categories
CREATE TYPE game_category AS ENUM (
  'action',
  'adventure',
  'rpg',
  'strategy',
  'simulation',
  'sports',
  'racing',
  'puzzle',
  'platformer',
  'other'
);

ALTER TABLE games
ADD COLUMN category game_category DEFAULT 'other';

-- Index ekle
CREATE INDEX idx_games_category ON games(category);
```

### Migration Geri Alma

```bash
# Son migration'u geri al
npx prisma migrate reset

# Belirli bir migration'a geri dÃ¶n
npx prisma migrate resolve --rolled-back 20240101000000_add_game_categories
```

## ðŸ“ˆ Performans Optimizasyonu

### Index'ler

```sql
-- User tablosu index'leri
CREATE INDEX idx_users_email ON users(email);
CREATE INDEX idx_users_username ON users(username);
CREATE INDEX idx_users_status ON users(status);
CREATE INDEX idx_users_last_active ON users(lastActive);

-- Game tablosu index'leri
CREATE INDEX idx_games_name ON games(name);
CREATE INDEX idx_games_release_date ON games(firstReleaseDate);
CREATE INDEX idx_games_rating ON games(rating);
CREATE INDEX idx_games_last_accessed ON games(lastAccessed);

-- LibraryEntry tablosu index'leri
CREATE INDEX idx_library_user_id ON library_entries(userId);
CREATE INDEX idx_library_game_id ON library_entries(gameId);
CREATE INDEX idx_library_category ON library_entries(category);
CREATE INDEX idx_library_priority ON library_entries(priority);
CREATE INDEX idx_library_last_played ON library_entries(lastPlayed);
CREATE INDEX idx_library_is_public ON library_entries(isPublic);

-- GameSession tablosu index'leri
CREATE INDEX idx_sessions_user_id ON game_sessions(userId);
CREATE INDEX idx_sessions_game_id ON game_sessions(gameId);
CREATE INDEX idx_sessions_start_time ON game_sessions(startTime);
CREATE INDEX idx_sessions_is_active ON game_sessions(isActive);
```

### Sorgu Optimizasyonu

#### KÃ¼tÃ¼phane Sorgusu

```sql
-- Optimize edilmiÅŸ kÃ¼tÃ¼phane sorgusu
SELECT
  le.id,
  le.category,
  le.playtime,
  le.rating,
  le.progress,
  le.lastPlayed,
  g.id as game_id,
  g.name as game_name,
  g.cover,
  g.rating as game_rating
FROM library_entries le
JOIN games g ON le.gameId = g.id
WHERE le.userId = $1
ORDER BY le.lastPlayed DESC NULLS LAST, le.priority ASC
LIMIT 50;
```

#### Ä°statistik Sorgusu

```sql
-- KullanÄ±cÄ± istatistikleri iÃ§in optimize edilmiÅŸ sorgu
SELECT
  COUNT(DISTINCT le.gameId) as total_games,
  SUM(le.playtime) as total_playtime,
  COUNT(gs.id) as total_sessions,
  COUNT(CASE WHEN le.category = 'completed' THEN 1 END) as completed_games
FROM library_entries le
LEFT JOIN game_sessions gs ON le.userId = gs.userId AND le.gameId = gs.gameId
WHERE le.userId = $1;
```

## ðŸ’¾ Backup ve Restore ProsedÃ¼rleri

### Backup Script

```javascript
// backend/scripts/backup-database.js
const { PrismaClient } = require("@prisma/client");
const fs = require("fs");
const path = require("path");

const prisma = new PrismaClient();

async function backupDatabase() {
  const timestamp = new Date().toISOString().replace(/[:.]/g, "-");
  const backupPath = path.join(__dirname, `../backups/backup-${timestamp}.sql`);

  try {
    // PostgreSQL backup komutu
    const { execSync } = require("child_process");
    const dbUrl = process.env.DATABASE_URL;

    execSync(`pg_dump "${dbUrl}" > "${backupPath}"`, {
      stdio: "inherit",
    });

    console.log(`Backup oluÅŸturuldu: ${backupPath}`);

    // Cloudflare R2'e yÃ¼kle
    await uploadToR2(backupPath);
  } catch (error) {
    console.error("Backup hatasÄ±:", error);
  } finally {
    await prisma.$disconnect();
  }
}

backupDatabase();
```

### Restore Script

```javascript
// backend/scripts/restore-database.js
const { PrismaClient } = require("@prisma/client");
const fs = require("fs");

const prisma = new PrismaClient();

async function restoreDatabase(backupFile) {
  try {
    // VeritabanÄ±nÄ± sÄ±fÄ±rla
    await prisma.$executeRaw`DROP SCHEMA public CASCADE`;
    await prisma.$executeRaw`CREATE SCHEMA public`;

    // Backup'tan geri yÃ¼kle
    const { execSync } = require("child_process");
    const dbUrl = process.env.DATABASE_URL;

    execSync(`psql "${dbUrl}" < "${backupFile}"`, {
      stdio: "inherit",
    });

    // Migration'larÄ± yeniden uygula
    execSync("npx prisma migrate deploy", {
      stdio: "inherit",
    });

    console.log("VeritabanÄ± baÅŸarÄ±yla geri yÃ¼klendi");
  } catch (error) {
    console.error("Restore hatasÄ±:", error);
  } finally {
    await prisma.$disconnect();
  }
}

// KullanÄ±m: node restore-database.js backup-2024-01-01.sql
restoreDatabase(process.argv[2]);
```

### Otomatik Backup

```bash
# Cron job ile gÃ¼nlÃ¼k backup
0 2 * * * cd /path/to/jun-oro/backend && npm run db:backup

# HaftalÄ±k backup temizliÄŸi (30 gÃ¼nden eski backup'larÄ± sil)
0 3 * * 0 find /path/to/backups -name "*.sql" -mtime +30 -delete
```

## ðŸ” Veri GÃ¼venliÄŸi

### Hassas Veri Åžifreleme

```javascript
// API key'leri ÅŸifreleme
const crypto = require("crypto");

function encryptApiKey(key) {
  const algorithm = "aes-256-gcm";
  const secretKey = process.env.ENCRYPTION_KEY;
  const iv = crypto.randomBytes(16);

  const cipher = crypto.createCipher(algorithm, secretKey, iv);

  let encrypted = cipher.update(key, "utf8", "hex");
  encrypted += cipher.final("hex");

  return {
    encrypted,
    iv: iv.toString("hex"),
  };
}
```

### Veri Temizleme PolitikasÄ±

```sql
-- 1 yÄ±ldan eski inactive kullanÄ±cÄ±larÄ± sil
DELETE FROM users
WHERE status = 'suspended'
AND lastActive < NOW() - INTERVAL '1 year';

-- 6 aydÄ±r eriÅŸilmeyen oyun verilerini temizle
DELETE FROM games
WHERE lastAccessed < NOW() - INTERVAL '6 months'
AND id NOT IN (SELECT gameId FROM library_entries);

-- 3 aydÄ±r aktif olmayan oturumlarÄ± kapat
UPDATE game_sessions
SET isActive = false, endTime = NOW()
WHERE isActive = true
AND startTime < NOW() - INTERVAL '3 days';
```

## ðŸ“Š Monitoring ve BakÄ±m

### VeritabanÄ± SaÄŸlÄ±k KontrolÃ¼

```sql
-- Tablo boyutlarÄ±
SELECT
  schemaname,
  tablename,
  pg_size_pretty(pg_total_relation_size(schemaname||'.'||tablename)) as size
FROM pg_tables
WHERE schemaname = 'public'
ORDER BY pg_total_relation_size(schemaname||'.'||tablename) DESC;

-- Index kullanÄ±mÄ±
SELECT
  schemaname,
  tablename,
  indexname,
  idx_scan,
  idx_tup_read,
  idx_tup_fetch
FROM pg_stat_user_indexes
ORDER BY idx_scan DESC;

-- YavaÅŸ sorgular
SELECT
  query,
  calls,
  total_time,
  mean_time,
  rows
FROM pg_stat_statements
ORDER BY mean_time DESC
LIMIT 10;
```

### BakÄ±m Script'leri

```bash
#!/bin/bash
# maintenance.sh

# VACUUM ve ANALYZE
psql $DATABASE_URL -c "VACUUM ANALYZE;"

# Index'leri yeniden oluÅŸtur
psql $DATABASE_URL -c "REINDEX DATABASE jun_oro;"

# Ä°statistikleri gÃ¼ncelle
psql $DATABASE_URL -c "ANALYZE;"

echo "VeritabanÄ± bakÄ±mÄ± tamamlandÄ±"
```

## ðŸ”® Gelecek GeliÅŸtirmeler

### Planlanan Ã–zellikler

- **Veri ArÅŸivleme**: Eski verileri arÅŸivleme sistemi
- **Replication**: Okuma iÅŸlemleri iÃ§in read replica
- **Partitioning**: BÃ¼yÃ¼k tablolar iÃ§in horizontal partitioning
- **Full-text Search**: Oyun aramasÄ± iÃ§in geliÅŸmiÅŸ arama

### Performans Ä°yileÅŸtirmeleri

- **Connection Pooling**: PgBouncer entegrasyonu
- **Query Caching**: Redis ile sorgu Ã¶nbellekleme
- **Materialized Views**: Raporlama iÃ§in optimize edilmiÅŸ view'lar
- **Database Sharding**: BÃ¼yÃ¼k Ã¶lÃ§ek iÃ§in veri daÄŸÄ±tÄ±mÄ±
